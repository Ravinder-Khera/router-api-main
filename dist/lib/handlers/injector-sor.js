import { ChainId } from '@uniswap/sdk-core';
import { CachingGasStationProvider, CachingTokenListProvider, CachingTokenProviderWithFallback, CachingV3PoolProvider, EIP1559GasPriceProvider, FallbackTenderlySimulator, TenderlySimulator, EthEstimateGasSimulator, LegacyGasPriceProvider, NodeJSCache, OnChainGasPriceProvider, OnChainQuoteProvider, setGlobalLogger, StaticV2SubgraphProvider, StaticV3SubgraphProvider, TokenProvider, UniswapMulticallProvider, V2PoolProvider, V2QuoteProvider, V3PoolProvider, } from '@uniswap/smart-order-router';
import { default as bunyan } from 'bunyan';
import _ from 'lodash';
import NodeCache from 'node-cache';
import UNSUPPORTED_TOKEN_LIST from './../config/unsupported.tokenlist.json';
import { Injector } from './handler';
import { V2AWSSubgraphProvider, V3AWSSubgraphProvider } from './router-entities/aws-subgraph-provider';
import { AWSTokenListProvider } from './router-entities/aws-token-list-provider';
import { DynamoRouteCachingProvider } from './router-entities/route-caching/dynamo-route-caching-provider';
import { DynamoDBCachingV3PoolProvider } from './pools/pool-caching/v3/dynamo-caching-pool-provider';
import { TrafficSwitchV3PoolProvider } from './pools/provider-migration/v3/traffic-switch-v3-pool-provider';
import { DefaultEVMClient } from './evm/EVMClient';
import { InstrumentedEVMProvider } from './evm/provider/InstrumentedEVMProvider';
import { deriveProviderName } from './evm/provider/ProviderName';
export const SUPPORTED_CHAINS = [
    ChainId.MAINNET,
    ChainId.OPTIMISM,
    ChainId.ARBITRUM_ONE,
    ChainId.ARBITRUM_GOERLI,
    ChainId.POLYGON,
    ChainId.POLYGON_MUMBAI,
    ChainId.GOERLI,
    ChainId.SEPOLIA,
    ChainId.CELO,
    ChainId.CELO_ALFAJORES,
    ChainId.BNB,
    ChainId.AVALANCHE,
];
const DEFAULT_TOKEN_LIST = 'https://gateway.ipfs.io/ipns/tokens.uniswap.org';
export class InjectorSOR extends Injector {
    async buildContainerInjected() {
        const log = bunyan.createLogger({
            name: this.injectorName,
            serializers: bunyan.stdSerializers,
            level: bunyan.INFO,
        });
        setGlobalLogger(log);
        const { POOL_CACHE_BUCKET_2, POOL_CACHE_KEY, TOKEN_LIST_CACHE_BUCKET, CACHED_ROUTES_TABLE_NAME } = process.env;
        const dependenciesByChain = {};
        const dependenciesByChainArray = await Promise.all(_.map(SUPPORTED_CHAINS, async (chainId) => {
            const url = process.env[`WEB3_RPC_${chainId.toString()}`];
            if (!url) {
                log.fatal({ chainId: chainId }, `Fatal: No Web3 RPC endpoint set for chain`);
                return { chainId, dependencies: {} };
                // This router instance will not be able to route through any chain
                // for which RPC URL is not set
                // For now, if RPC URL is not set for a chain, a request to route
                // on the chain will return Err 500
            }
            let timeout;
            switch (chainId) {
                case ChainId.ARBITRUM_ONE:
                    timeout = 8000;
                    break;
                default:
                    timeout = 5000;
                    break;
            }
            const provider = new DefaultEVMClient({
                allProviders: [
                    new InstrumentedEVMProvider({
                        url: {
                            url: url,
                            timeout,
                        },
                        network: chainId,
                        name: deriveProviderName(url),
                    }),
                ],
            }).getProvider();
            const tokenListProvider = await AWSTokenListProvider.fromTokenListS3Bucket(chainId, TOKEN_LIST_CACHE_BUCKET, DEFAULT_TOKEN_LIST);
            const tokenCache = new NodeJSCache(new NodeCache({ stdTTL: 3600, useClones: false }));
            const blockedTokenCache = new NodeJSCache(new NodeCache({ stdTTL: 3600, useClones: false }));
            const multicall2Provider = new UniswapMulticallProvider(chainId, provider, 375000);
            const tokenProvider = new CachingTokenProviderWithFallback(chainId, tokenCache, tokenListProvider, new TokenProvider(chainId, multicall2Provider));
            // Some providers like Infura set a gas limit per call of 10x block gas which is approx 150m
            // 200*725k < 150m
            let quoteProvider = undefined;
            switch (chainId) {
                case ChainId.OPTIMISM:
                    quoteProvider = new OnChainQuoteProvider(chainId, provider, multicall2Provider, {
                        retries: 2,
                        minTimeout: 100,
                        maxTimeout: 1000,
                    }, {
                        multicallChunk: 110,
                        gasLimitPerCall: 1200000,
                        quoteMinSuccessRate: 0.1,
                    }, {
                        gasLimitOverride: 3000000,
                        multicallChunk: 45,
                    }, {
                        gasLimitOverride: 3000000,
                        multicallChunk: 45,
                    }, {
                        baseBlockOffset: -25,
                        rollback: {
                            enabled: true,
                            attemptsBeforeRollback: 1,
                            rollbackBlockOffset: -20,
                        },
                    });
                    break;
                case ChainId.ARBITRUM_ONE:
                    quoteProvider = new OnChainQuoteProvider(chainId, provider, multicall2Provider, {
                        retries: 2,
                        minTimeout: 100,
                        maxTimeout: 1000,
                    }, {
                        multicallChunk: 15,
                        gasLimitPerCall: 15000000,
                        quoteMinSuccessRate: 0.15,
                    }, {
                        gasLimitOverride: 30000000,
                        multicallChunk: 8,
                    }, {
                        gasLimitOverride: 30000000,
                        multicallChunk: 8,
                    }, {
                        baseBlockOffset: 0,
                        rollback: {
                            enabled: true,
                            attemptsBeforeRollback: 1,
                            rollbackBlockOffset: -10,
                        },
                    });
                    break;
            }
            const noCacheV3PoolProvider = new V3PoolProvider(chainId, multicall2Provider);
            const inMemoryCachingV3PoolProvider = new CachingV3PoolProvider(chainId, noCacheV3PoolProvider, new NodeJSCache(new NodeCache({ stdTTL: 180, useClones: false })));
            const dynamoCachingV3PoolProvider = new DynamoDBCachingV3PoolProvider(chainId, noCacheV3PoolProvider, 'V3PoolsCachingDB');
            const v3PoolProvider = new TrafficSwitchV3PoolProvider({
                currentPoolProvider: inMemoryCachingV3PoolProvider,
                targetPoolProvider: dynamoCachingV3PoolProvider,
                sourceOfTruthPoolProvider: noCacheV3PoolProvider,
            });
            const v2PoolProvider = new V2PoolProvider(chainId, multicall2Provider);
            const tenderlySimulator = new TenderlySimulator(chainId, 'http://api.tenderly.co', process.env.TENDERLY_USER, process.env.TENDERLY_PROJECT, process.env.TENDERLY_ACCESS_KEY, v2PoolProvider, v3PoolProvider, provider, { [ChainId.ARBITRUM_ONE]: 2.5 });
            const ethEstimateGasSimulator = new EthEstimateGasSimulator(chainId, provider, v2PoolProvider, v3PoolProvider);
            const simulator = new FallbackTenderlySimulator(chainId, provider, tenderlySimulator, ethEstimateGasSimulator);
            const [v3SubgraphProvider, v2SubgraphProvider] = await Promise.all([
                (async () => {
                    try {
                        const subgraphProvider = await V3AWSSubgraphProvider.EagerBuild(POOL_CACHE_BUCKET_2, POOL_CACHE_KEY, chainId);
                        return subgraphProvider;
                    }
                    catch (err) {
                        log.error({ err }, 'AWS Subgraph Provider unavailable, defaulting to Static Subgraph Provider');
                        return new StaticV3SubgraphProvider(chainId, v3PoolProvider);
                    }
                })(),
                (async () => {
                    try {
                        const subgraphProvider = await V2AWSSubgraphProvider.EagerBuild(POOL_CACHE_BUCKET_2, POOL_CACHE_KEY, chainId);
                        return subgraphProvider;
                    }
                    catch (err) {
                        return new StaticV2SubgraphProvider(chainId);
                    }
                })(),
            ]);
            let routeCachingProvider = undefined;
            if (CACHED_ROUTES_TABLE_NAME && CACHED_ROUTES_TABLE_NAME !== '') {
                routeCachingProvider = new DynamoRouteCachingProvider({ cachedRoutesTableName: CACHED_ROUTES_TABLE_NAME });
            }
            return {
                chainId,
                dependencies: {
                    provider,
                    tokenListProvider: await AWSTokenListProvider.fromTokenListS3Bucket(chainId, TOKEN_LIST_CACHE_BUCKET, DEFAULT_TOKEN_LIST),
                    blockedTokenListProvider: await CachingTokenListProvider.fromTokenList(chainId, UNSUPPORTED_TOKEN_LIST, blockedTokenCache),
                    multicallProvider: multicall2Provider,
                    tokenProvider,
                    tokenProviderFromTokenList: tokenListProvider,
                    gasPriceProvider: new CachingGasStationProvider(chainId, new OnChainGasPriceProvider(chainId, new EIP1559GasPriceProvider(provider), new LegacyGasPriceProvider(provider)), new NodeJSCache(new NodeCache({ stdTTL: 15, useClones: false }))),
                    v3SubgraphProvider,
                    onChainQuoteProvider: quoteProvider,
                    v3PoolProvider,
                    v2PoolProvider,
                    v2QuoteProvider: new V2QuoteProvider(),
                    v2SubgraphProvider,
                    simulator,
                    routeCachingProvider,
                },
            };
        }));
        for (const { chainId, dependencies } of dependenciesByChainArray) {
            dependenciesByChain[chainId] = dependencies;
        }
        return {
            dependencies: dependenciesByChain,
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5qZWN0b3Itc29yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vbGliL2hhbmRsZXJzL2luamVjdG9yLXNvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsT0FBTyxFQUFTLE1BQU0sbUJBQW1CLENBQUE7QUFDbEQsT0FBTyxFQUNMLHlCQUF5QixFQUN6Qix3QkFBd0IsRUFDeEIsZ0NBQWdDLEVBQ2hDLHFCQUFxQixFQUNyQix1QkFBdUIsRUFDdkIseUJBQXlCLEVBQ3pCLGlCQUFpQixFQUNqQix1QkFBdUIsRUFVdkIsc0JBQXNCLEVBQ3RCLFdBQVcsRUFDWCx1QkFBdUIsRUFDdkIsb0JBQW9CLEVBQ3BCLGVBQWUsRUFDZix3QkFBd0IsRUFDeEIsd0JBQXdCLEVBQ3hCLGFBQWEsRUFDYix3QkFBd0IsRUFDeEIsY0FBYyxFQUNkLGVBQWUsRUFDZixjQUFjLEdBRWYsTUFBTSw2QkFBNkIsQ0FBQTtBQUVwQyxPQUFPLEVBQUUsT0FBTyxJQUFJLE1BQU0sRUFBcUIsTUFBTSxRQUFRLENBQUE7QUFFN0QsT0FBTyxDQUFDLE1BQU0sUUFBUSxDQUFBO0FBQ3RCLE9BQU8sU0FBUyxNQUFNLFlBQVksQ0FBQTtBQUNsQyxPQUFPLHNCQUFzQixNQUFNLHdDQUF3QyxDQUFBO0FBQzNFLE9BQU8sRUFBWSxRQUFRLEVBQUUsTUFBTSxXQUFXLENBQUE7QUFDOUMsT0FBTyxFQUFFLHFCQUFxQixFQUFFLHFCQUFxQixFQUFFLE1BQU0seUNBQXlDLENBQUE7QUFDdEcsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMkNBQTJDLENBQUE7QUFDaEYsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0sK0RBQStELENBQUE7QUFDMUcsT0FBTyxFQUFFLDZCQUE2QixFQUFFLE1BQU0sc0RBQXNELENBQUE7QUFDcEcsT0FBTyxFQUFFLDJCQUEyQixFQUFFLE1BQU0sK0RBQStELENBQUE7QUFDM0csT0FBTyxFQUFFLGdCQUFnQixFQUFF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LEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FDakU7b0JBQ0Qsa0JBQWtCO29CQUNsQixvQkFBb0IsRUFBRSxhQUFhO29CQUNuQyxjQUFjO29CQUNkLGNBQWM7b0JBQ2QsZUFBZSxFQUFFLElBQUksZUFBZSxFQUFFO29CQUN0QyxrQkFBa0I7b0JBQ2xCLFNBQVM7b0JBQ1Qsb0JBQW9CO2lCQUNyQjthQUNGLENBQUE7UUFDSCxDQUFDLENBQUMsQ0FDSCxDQUFBO1FBRUQsS0FBSyxNQUFNLEVBQUUsT0FBTyxFQUFFLFlBQVksRUFBRSxJQUFJLHdCQUF3QixFQUFFO1lBQ2hFLG1CQUFtQixDQUFDLE9BQU8sQ0FBQyxHQUFHLFlBQVksQ0FBQTtTQUM1QztRQUVELE9BQU87WUFDTCxZQUFZLEVBQUUsbUJBQW1CO1NBQ2xDLENBQUE7SUFDSCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDaGFpbklkLCBUb2tlbiB9IGZyb20gJ0B1bmlzd2FwL3Nkay1jb3JlJ1xuaW1wb3J0IHtcbiAgQ2FjaGluZ0dhc1N0YXRpb25Qcm92aWRlcixcbiAgQ2FjaGluZ1Rva2VuTGlzdFByb3ZpZGVyLFxuICBDYWNoaW5nVG9rZW5Qcm92aWRlcldpdGhGYWxsYmFjayxcbiAgQ2FjaGluZ1YzUG9vbFByb3ZpZGVyLFxuICBFSVAxNTU5R2FzUHJpY2VQcm92aWRlcixcbiAgRmFsbGJhY2tUZW5kZXJseVNpbXVsYXRvcixcbiAgVGVuZGVybHlTaW11bGF0b3IsXG4gIEV0aEVzdGltYXRlR2FzU2ltdWxhdG9yLFxuICBJR2FzUHJpY2VQcm92aWRlcixcbiAgSU1ldHJpYyxcbiAgU2ltdWxhdG9yLFxuICBJVG9rZW5MaXN0UHJvdmlkZXIsXG4gIElUb2tlblByb3ZpZGVyLFxuICBJVjJQb29sUHJvdmlkZXIsXG4gIElWMlN1YmdyYXBoUHJvdmlkZXIsXG4gIElWM1Bvb2xQcm92aWRlcixcbiAgSVYzU3ViZ3JhcGhQcm92aWRlcixcbiAgTGVnYWN5R2FzUHJpY2VQcm92aWRlcixcbiAgTm9kZUpTQ2FjaGUsXG4gIE9uQ2hhaW5HYXNQcmljZVByb3ZpZGVyLFxuICBPbkNoYWluUXVvdGVQcm92aWRlcixcbiAgc2V0R2xvYmFsTG9nZ2VyLFxuICBTdGF0aWNWMlN1YmdyYXBoUHJvdmlkZXIsXG4gIFN0YXRpY1YzU3ViZ3JhcGhQcm92aWRlcixcbiAgVG9rZW5Qcm92aWRlcixcbiAgVW5pc3dhcE11bHRpY2FsbFByb3ZpZGVyLFxuICBWMlBvb2xQcm92aWRlcixcbiAgVjJRdW90ZVByb3ZpZGVyLFxuICBWM1Bvb2xQcm92aWRlcixcbiAgSVJvdXRlQ2FjaGluZ1Byb3ZpZGVyLFxufSBmcm9tICdAdW5pc3dhcC9zbWFydC1vcmRlci1yb3V0ZXInXG5pbXBvcnQgeyBUb2tlbkxpc3QgfSBmcm9tICdAdW5pc3dhcC90b2tlbi1saXN0cydcbmltcG9ydCB7IGRlZmF1bHQgYXMgYnVueWFuLCBkZWZhdWx0IGFzIExvZ2dlciB9IGZyb20gJ2J1bnlhbidcbmltcG9ydCB7IGV0aGVycyB9IGZyb20gJ2V0aGVycydcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCdcbmltcG9ydCBOb2RlQ2FjaGUgZnJvbSAnbm9kZS1jYWNoZSdcbmltcG9ydCBVTlNVUFBPUlRFRF9UT0tFTl9MSVNUIGZyb20gJy4vLi4vY29uZmlnL3Vuc3VwcG9ydGVkLnRva2VubGlzdC5qc29uJ1xuaW1wb3J0IHsgQmFzZVJJbmosIEluamVjdG9yIH0gZnJvbSAnLi9oYW5kbGVyJ1xuaW1wb3J0IHsgVjJBV1NTdWJncmFwaFByb3ZpZGVyLCBWM0FXU1N1YmdyYXBoUHJvdmlkZXIgfSBmcm9tICcuL3JvdXRlci1lbnRpdGllcy9hd3Mtc3ViZ3JhcGgtcHJvdmlkZXInXG5pbXBvcnQgeyBBV1NUb2tlbkxpc3RQcm92aWRlciB9IGZyb20gJy4vcm91dGVyLWVudGl0aWVzL2F3cy10b2tlbi1saXN0LXByb3ZpZGVyJ1xuaW1wb3J0IHsgRHluYW1vUm91dGVDYWNoaW5nUHJvdmlkZXIgfSBmcm9tICcuL3JvdXRlci1lbnRpdGllcy9yb3V0ZS1jYWNoaW5nL2R5bmFtby1yb3V0ZS1jYWNoaW5nLXByb3ZpZGVyJ1xuaW1wb3J0IHsgRHluYW1vREJDYWNoaW5nVjNQb29sUHJvdmlkZXIgfSBmcm9tICcuL3Bvb2xzL3Bvb2wtY2FjaGluZy92My9keW5hbW8tY2FjaGluZy1wb29sLXByb3ZpZGVyJ1xuaW1wb3J0IHsgVHJhZmZpY1N3aXRjaFYzUG9vbFByb3ZpZGVyIH0gZnJvbSAnLi9wb29scy9wcm92aWRlci1taWdyYXRpb24vdjMvdHJhZmZpYy1zd2l0Y2gtdjMtcG9vbC1wcm92aWRlcidcbmltcG9ydCB7IERlZmF1bHRFVk1DbGllbnQgfSBmcm9tICcuL2V2bS9FVk1DbGllbnQnXG5pbXBvcnQgeyBJbnN0cnVtZW50ZWRFVk1Qcm92aWRlciB9IGZyb20gJy4vZXZtL3Byb3ZpZGVyL0luc3RydW1lbnRlZEVWTVByb3ZpZGVyJ1xuaW1wb3J0IHsgZGVyaXZlUHJvdmlkZXJOYW1lIH0gZnJvbSAnLi9ldm0vcHJvdmlkZXIvUHJvdmlkZXJOYW1lJ1xuXG5leHBvcnQgY29uc3QgU1VQUE9SVEVEX0NIQUlOUzogQ2hhaW5JZFtdID0gW1xuICBDaGFpbklkLk1BSU5ORVQsXG4gIENoYWluSWQuT1BUSU1JU00sXG4gIENoYWluSWQuQVJCSVRSVU1fT05FLFxuICBDaGFpbklkLkFSQklUUlVNX0dPRVJMSSxcbiAgQ2hhaW5JZC5QT0xZR09OLFxuICBDaGFpbklkLlBPTFlHT05fTVVNQkFJLFxuICBDaGFpbklkLkdPRVJMSSxcbiAgQ2hhaW5JZC5TRVBPTElBLFxuICBDaGFpbklkLkNFTE8sXG4gIENoYWluSWQuQ0VMT19BTEZBSk9SRVMsXG4gIENoYWluSWQuQk5CLFxuICBDaGFpbklkLkFWQUxBTkNIRSxcbl1cbmNvbnN0IERFRkFVTFRfVE9LRU5fTElTVCA9ICdodHRwczovL2dhdGV3YXkuaXBmcy5pby9pcG5zL3Rva2Vucy51bmlzd2FwLm9yZydcblxuZXhwb3J0IGludGVyZmFjZSBSZXF1ZXN0SW5qZWN0ZWQ8Um91dGVyPiBleHRlbmRzIEJhc2VSSW5qIHtcbiAgY2hhaW5JZDogQ2hhaW5JZFxuICBtZXRyaWM6IElNZXRyaWNcbiAgdjNQb29sUHJvdmlkZXI6IElWM1Bvb2xQcm92aWRlclxuICB2MlBvb2xQcm92aWRlcjogSVYyUG9vbFByb3ZpZGVyXG4gIHRva2VuUHJvdmlkZXI6IElUb2tlblByb3ZpZGVyXG4gIHRva2VuTGlzdFByb3ZpZGVyOiBJVG9rZW5MaXN0UHJvdmlkZXJcbiAgcm91dGVyOiBSb3V0ZXJcbn1cblxuZXhwb3J0IHR5cGUgQ29udGFpbmVyRGVwZW5kZW5jaWVzID0ge1xuICBwcm92aWRlcjogZXRoZXJzLnByb3ZpZGVycy5Kc29uUnBjUHJvdmlkZXJcbiAgdjNTdWJncmFwaFByb3ZpZGVyOiBJVjNTdWJncmFwaFByb3ZpZGVyXG4gIHYyU3ViZ3JhcGhQcm92aWRlcjogSVYyU3ViZ3JhcGhQcm92aWRlclxuICB0b2tlbkxpc3RQcm92aWRlcjogSVRva2VuTGlzdFByb3ZpZGVyXG4gIGdhc1ByaWNlUHJvdmlkZXI6IElHYXNQcmljZVByb3ZpZGVyXG4gIHRva2VuUHJvdmlkZXJGcm9tVG9rZW5MaXN0OiBJVG9rZW5Qcm92aWRlclxuICBibG9ja2VkVG9rZW5MaXN0UHJvdmlkZXI6IElUb2tlbkxpc3RQcm92aWRlclxuICB2M1Bvb2xQcm92aWRlcjogSVYzUG9vbFByb3ZpZGVyXG4gIHYyUG9vbFByb3ZpZGVyOiBJVjJQb29sUHJvdmlkZXJcbiAgdG9rZW5Qcm92aWRlcjogSVRva2VuUHJvdmlkZXJcbiAgbXVsdGljYWxsUHJvdmlkZXI6IFVuaXN3YXBNdWx0aWNhbGxQcm92aWRlclxuICBvbkNoYWluUXVvdGVQcm92aWRlcj86IE9uQ2hhaW5RdW90ZVByb3ZpZGVyXG4gIHYyUXVvdGVQcm92aWRlcjogVjJRdW90ZVByb3ZpZGVyXG4gIHNpbXVsYXRvcjogU2ltdWxhdG9yXG4gIHJvdXRlQ2FjaGluZ1Byb3ZpZGVyPzogSVJvdXRlQ2FjaGluZ1Byb3ZpZGVyXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29udGFpbmVySW5qZWN0ZWQge1xuICBkZXBlbmRlbmNpZXM6IHtcbiAgICBbY2hhaW5JZCBpbiBDaGFpbklkXT86IENvbnRhaW5lckRlcGVuZGVuY2llc1xuICB9XG59XG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBJbmplY3RvclNPUjxSb3V0ZXIsIFF1ZXJ5UGFyYW1zPiBleHRlbmRzIEluamVjdG9yPFxuICBDb250YWluZXJJbmplY3RlZCxcbiAgUmVxdWVzdEluamVjdGVkPFJvdXRlcj4sXG4gIHZvaWQsXG4gIFF1ZXJ5UGFyYW1zXG4+IHtcbiAgcHVibGljIGFzeW5jIGJ1aWxkQ29udGFpbmVySW5qZWN0ZWQoKTogUHJvbWlzZTxDb250YWluZXJJbmplY3RlZD4ge1xuICAgIGNvbnN0IGxvZzogTG9nZ2VyID0gYnVueWFuLmNyZWF0ZUxvZ2dlcih7XG4gICAgICBuYW1lOiB0aGlzLmluamVjdG9yTmFtZSxcbiAgICAgIHNlcmlhbGl6ZXJzOiBidW55YW4uc3RkU2VyaWFsaXplcnMsXG4gICAgICBsZXZlbDogYnVueWFuLklORk8sXG4gICAgfSlcbiAgICBzZXRHbG9iYWxMb2dnZXIobG9nKVxuXG4gICAgY29uc3QgeyBQT09MX0NBQ0hFX0JVQ0tFVF8yLCBQT09MX0NBQ0hFX0tFWSwgVE9LRU5fTElTVF9DQUNIRV9CVUNLRVQsIENBQ0hFRF9ST1VURVNfVEFCTEVfTkFNRSB9ID0gcHJvY2Vzcy5lbnZcblxuICAgIGNvbnN0IGRlcGVuZGVuY2llc0J5Q2hhaW46IHtcbiAgICAgIFtjaGFpbklkIGluIENoYWluSWRdPzogQ29udGFpbmVyRGVwZW5kZW5jaWVzXG4gICAgfSA9IHt9XG5cbiAgICBjb25zdCBkZXBlbmRlbmNpZXNCeUNoYWluQXJyYXkgPSBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgIF8ubWFwKFNVUFBPUlRFRF9DSEFJTlMsIGFzeW5jIChjaGFpbklkOiBDaGFpbklkKSA9PiB7XG4gICAgICAgIGNvbnN0IHVybCA9IHByb2Nlc3MuZW52W2BXRUIzX1JQQ18ke2NoYWluSWQudG9TdHJpbmcoKX1gXSFcblxuICAgICAgICBpZiAoIXVybCkge1xuICAgICAgICAgIGxvZy5mYXRhbCh7IGNoYWluSWQ6IGNoYWluSWQgfSwgYEZhdGFsOiBObyBXZWIzIFJQQyBlbmRwb2ludCBzZXQgZm9yIGNoYWluYClcbiAgICAgICAgICByZXR1cm4geyBjaGFpbklkLCBkZXBlbmRlbmNpZXM6IHt9IGFzIENvbnRhaW5lckRlcGVuZGVuY2llcyB9XG4gICAgICAgICAgLy8gVGhpcyByb3V0ZXIgaW5zdGFuY2Ugd2lsbCBub3QgYmUgYWJsZSB0byByb3V0ZSB0aHJvdWdoIGFueSBjaGFpblxuICAgICAgICAgIC8vIGZvciB3aGljaCBSUEMgVVJMIGlzIG5vdCBzZXRcbiAgICAgICAgICAvLyBGb3Igbm93LCBpZiBSUEMgVVJMIGlzIG5vdCBzZXQgZm9yIGEgY2hhaW4sIGEgcmVxdWVzdCB0byByb3V0ZVxuICAgICAgICAgIC8vIG9uIHRoZSBjaGFpbiB3aWxsIHJldHVybiBFcnIgNTAwXG4gICAgICAgIH1cblxuICAgICAgICBsZXQgdGltZW91dDogbnVtYmVyXG4gICAgICAgIHN3aXRjaCAoY2hhaW5JZCkge1xuICAgICAgICAgIGNhc2UgQ2hhaW5JZC5BUkJJVFJVTV9PTkU6XG4gICAgICAgICAgICB0aW1lb3V0ID0gODAwMFxuICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgdGltZW91dCA9IDUwMDBcbiAgICAgICAgICAgIGJyZWFrXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBwcm92aWRlciA9IG5ldyBEZWZhdWx0RVZNQ2xpZW50KHtcbiAgICAgICAgICBhbGxQcm92aWRlcnM6IFtcbiAgICAgICAgICAgIG5ldyBJbnN0cnVtZW50ZWRFVk1Qcm92aWRlcih7XG4gICAgICAgICAgICAgIHVybDoge1xuICAgICAgICAgICAgICAgIHVybDogdXJsLFxuICAgICAgICAgICAgICAgIHRpbWVvdXQsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIG5ldHdvcms6IGNoYWluSWQsXG4gICAgICAgICAgICAgIG5hbWU6IGRlcml2ZVByb3ZpZGVyTmFtZSh1cmwpLFxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgXSxcbiAgICAgICAgfSkuZ2V0UHJvdmlkZXIoKVxuXG4gICAgICAgIGNvbnN0IHRva2VuTGlzdFByb3ZpZGVyID0gYXdhaXQgQVdTVG9rZW5MaXN0UHJvdmlkZXIuZnJvbVRva2VuTGlzdFMzQnVja2V0KFxuICAgICAgICAgIGNoYWluSWQsXG4gICAgICAgICAgVE9LRU5fTElTVF9DQUNIRV9CVUNLRVQhLFxuICAgICAgICAgIERFRkFVTFRfVE9LRU5fTElTVFxuICAgICAgICApXG5cbiAgICAgICAgY29uc3QgdG9rZW5DYWNoZSA9IG5ldyBOb2RlSlNDYWNoZTxUb2tlbj4obmV3IE5vZGVDYWNoZSh7IHN0ZFRUTDogMzYwMCwgdXNlQ2xvbmVzOiBmYWxzZSB9KSlcbiAgICAgICAgY29uc3QgYmxvY2tlZFRva2VuQ2FjaGUgPSBuZXcgTm9kZUpTQ2FjaGU8VG9rZW4+KG5ldyBOb2RlQ2FjaGUoeyBzdGRUVEw6IDM2MDAsIHVzZUNsb25lczogZmFsc2UgfSkpXG5cbiAgICAgICAgY29uc3QgbXVsdGljYWxsMlByb3ZpZGVyID0gbmV3IFVuaXN3YXBNdWx0aWNhbGxQcm92aWRlcihjaGFpbklkLCBwcm92aWRlciwgMzc1XzAwMClcbiAgICAgICAgY29uc3QgdG9rZW5Qcm92aWRlciA9IG5ldyBDYWNoaW5nVG9rZW5Qcm92aWRlcldpdGhGYWxsYmFjayhcbiAgICAgICAgICBjaGFpbklkLFxuICAgICAgICAgIHRva2VuQ2FjaGUsXG4gICAgICAgICAgdG9rZW5MaXN0UHJvdmlkZXIsXG4gICAgICAgICAgbmV3IFRva2VuUHJvdmlkZXIoY2hhaW5JZCwgbXVsdGljYWxsMlByb3ZpZGVyKVxuICAgICAgICApXG5cbiAgICAgICAgLy8gU29tZSBwcm92aWRlcnMgbGlrZSBJbmZ1cmEgc2V0IGEgZ2FzIGxpbWl0IHBlciBjYWxsIG9mIDEweCBibG9jayBnYXMgd2hpY2ggaXMgYXBwcm94IDE1MG1cbiAgICAgICAgLy8gMjAwKjcyNWsgPCAxNTBtXG4gICAgICAgIGxldCBxdW90ZVByb3ZpZGVyOiBPbkNoYWluUXVvdGVQcm92aWRlciB8IHVuZGVmaW5lZCA9IHVuZGVmaW5lZFxuICAgICAgICBzd2l0Y2ggKGNoYWluSWQpIHtcbiAgICAgICAgICBjYXNlIENoYWluSWQuT1BUSU1JU006XG4gICAgICAgICAgICBxdW90ZVByb3ZpZGVyID0gbmV3IE9uQ2hhaW5RdW90ZVByb3ZpZGVyKFxuICAgICAgICAgICAgICBjaGFpbklkLFxuICAgICAgICAgICAgICBwcm92aWRlcixcbiAgICAgICAgICAgICAgbXVsdGljYWxsMlByb3ZpZGVyLFxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgcmV0cmllczogMixcbiAgICAgICAgICAgICAgICBtaW5UaW1lb3V0OiAxMDAsXG4gICAgICAgICAgICAgICAgbWF4VGltZW91dDogMTAwMCxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIG11bHRpY2FsbENodW5rOiAxMTAsXG4gICAgICAgICAgICAgICAgZ2FzTGltaXRQZXJDYWxsOiAxXzIwMF8wMDAsXG4gICAgICAgICAgICAgICAgcXVvdGVNaW5TdWNjZXNzUmF0ZTogMC4xLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgZ2FzTGltaXRPdmVycmlkZTogM18wMDBfMDAwLFxuICAgICAgICAgICAgICAgIG11bHRpY2FsbENodW5rOiA0NSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGdhc0xpbWl0T3ZlcnJpZGU6IDNfMDAwXzAwMCxcbiAgICAgICAgICAgICAgICBtdWx0aWNhbGxDaHVuazogNDUsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBiYXNlQmxvY2tPZmZzZXQ6IC0yNSxcbiAgICAgICAgICAgICAgICByb2xsYmFjazoge1xuICAgICAgICAgICAgICAgICAgZW5hYmxlZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgIGF0dGVtcHRzQmVmb3JlUm9sbGJhY2s6IDEsXG4gICAgICAgICAgICAgICAgICByb2xsYmFja0Jsb2NrT2Zmc2V0OiAtMjAsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICBjYXNlIENoYWluSWQuQVJCSVRSVU1fT05FOlxuICAgICAgICAgICAgcXVvdGVQcm92aWRlciA9IG5ldyBPbkNoYWluUXVvdGVQcm92aWRlcihcbiAgICAgICAgICAgICAgY2hhaW5JZCxcbiAgICAgICAgICAgICAgcHJvdmlkZXIsXG4gICAgICAgICAgICAgIG11bHRpY2FsbDJQcm92aWRlcixcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIHJldHJpZXM6IDIsXG4gICAgICAgICAgICAgICAgbWluVGltZW91dDogMTAwLFxuICAgICAgICAgICAgICAgIG1heFRpbWVvdXQ6IDEwMDAsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBtdWx0aWNhbGxDaHVuazogMTUsXG4gICAgICAgICAgICAgICAgZ2FzTGltaXRQZXJDYWxsOiAxNV8wMDBfMDAwLFxuICAgICAgICAgICAgICAgIHF1b3RlTWluU3VjY2Vzc1JhdGU6IDAuMTUsXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBnYXNMaW1pdE92ZXJyaWRlOiAzMF8wMDBfMDAwLFxuICAgICAgICAgICAgICAgIG11bHRpY2FsbENodW5rOiA4LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgZ2FzTGltaXRPdmVycmlkZTogMzBfMDAwXzAwMCxcbiAgICAgICAgICAgICAgICBtdWx0aWNhbGxDaHVuazogOCxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGJhc2VCbG9ja09mZnNldDogMCxcbiAgICAgICAgICAgICAgICByb2xsYmFjazoge1xuICAgICAgICAgICAgICAgICAgZW5hYmxlZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgIGF0dGVtcHRzQmVmb3JlUm9sbGJhY2s6IDEsXG4gICAgICAgICAgICAgICAgICByb2xsYmFja0Jsb2NrT2Zmc2V0OiAtMTAsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IG5vQ2FjaGVWM1Bvb2xQcm92aWRlciA9IG5ldyBWM1Bvb2xQcm92aWRlcihjaGFpbklkLCBtdWx0aWNhbGwyUHJvdmlkZXIpXG4gICAgICAgIGNvbnN0IGluTWVtb3J5Q2FjaGluZ1YzUG9vbFByb3ZpZGVyID0gbmV3IENhY2hpbmdWM1Bvb2xQcm92aWRlcihcbiAgICAgICAgICBjaGFpbklkLFxuICAgICAgICAgIG5vQ2FjaGVWM1Bvb2xQcm92aWRlcixcbiAgICAgICAgICBuZXcgTm9kZUpTQ2FjaGUobmV3IE5vZGVDYWNoZSh7IHN0ZFRUTDogMTgwLCB1c2VDbG9uZXM6IGZhbHNlIH0pKVxuICAgICAgICApXG4gICAgICAgIGNvbnN0IGR5bmFtb0NhY2hpbmdWM1Bvb2xQcm92aWRlciA9IG5ldyBEeW5hbW9EQkNhY2hpbmdWM1Bvb2xQcm92aWRlcihcbiAgICAgICAgICBjaGFpbklkLFxuICAgICAgICAgIG5vQ2FjaGVWM1Bvb2xQcm92aWRlcixcbiAgICAgICAgICAnVjNQb29sc0NhY2hpbmdEQidcbiAgICAgICAgKVxuXG4gICAgICAgIGNvbnN0IHYzUG9vbFByb3ZpZGVyID0gbmV3IFRyYWZmaWNTd2l0Y2hWM1Bvb2xQcm92aWRlcih7XG4gICAgICAgICAgY3VycmVudFBvb2xQcm92aWRlcjogaW5NZW1vcnlDYWNoaW5nVjNQb29sUHJvdmlkZXIsXG4gICAgICAgICAgdGFyZ2V0UG9vbFByb3ZpZGVyOiBkeW5hbW9DYWNoaW5nVjNQb29sUHJvdmlkZXIsXG4gICAgICAgICAgc291cmNlT2ZUcnV0aFBvb2xQcm92aWRlcjogbm9DYWNoZVYzUG9vbFByb3ZpZGVyLFxuICAgICAgICB9KVxuXG4gICAgICAgIGNvbnN0IHYyUG9vbFByb3ZpZGVyID0gbmV3IFYyUG9vbFByb3ZpZGVyKGNoYWluSWQsIG11bHRpY2FsbDJQcm92aWRlcilcblxuICAgICAgICBjb25zdCB0ZW5kZXJseVNpbXVsYXRvciA9IG5ldyBUZW5kZXJseVNpbXVsYXRvcihcbiAgICAgICAgICBjaGFpbklkLFxuICAgICAgICAgICdodHRwOi8vYXBpLnRlbmRlcmx5LmNvJyxcbiAgICAgICAgICBwcm9jZXNzLmVudi5URU5ERVJMWV9VU0VSISxcbiAgICAgICAgICBwcm9jZXNzLmVudi5URU5ERVJMWV9QUk9KRUNUISxcbiAgICAgICAgICBwcm9jZXNzLmVudi5URU5ERVJMWV9BQ0NFU1NfS0VZISxcbiAgICAgICAgICB2MlBvb2xQcm92aWRlcixcbiAgICAgICAgICB2M1Bvb2xQcm92aWRlcixcbiAgICAgICAgICBwcm92aWRlcixcbiAgICAgICAgICB7IFtDaGFpbklkLkFSQklUUlVNX09ORV06IDIuNSB9XG4gICAgICAgIClcblxuICAgICAgICBjb25zdCBldGhFc3RpbWF0ZUdhc1NpbXVsYXRvciA9IG5ldyBFdGhFc3RpbWF0ZUdhc1NpbXVsYXRvcihjaGFpbklkLCBwcm92aWRlciwgdjJQb29sUHJvdmlkZXIsIHYzUG9vbFByb3ZpZGVyKVxuXG4gICAgICAgIGNvbnN0IHNpbXVsYXRvciA9IG5ldyBGYWxsYmFja1RlbmRlcmx5U2ltdWxhdG9yKGNoYWluSWQsIHByb3ZpZGVyLCB0ZW5kZXJseVNpbXVsYXRvciwgZXRoRXN0aW1hdGVHYXNTaW11bGF0b3IpXG5cbiAgICAgICAgY29uc3QgW3YzU3ViZ3JhcGhQcm92aWRlciwgdjJTdWJncmFwaFByb3ZpZGVyXSA9IGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgICAgICAoYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgY29uc3Qgc3ViZ3JhcGhQcm92aWRlciA9IGF3YWl0IFYzQVdTU3ViZ3JhcGhQcm92aWRlci5FYWdlckJ1aWxkKFxuICAgICAgICAgICAgICAgIFBPT0xfQ0FDSEVfQlVDS0VUXzIhLFxuICAgICAgICAgICAgICAgIFBPT0xfQ0FDSEVfS0VZISxcbiAgICAgICAgICAgICAgICBjaGFpbklkXG4gICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgcmV0dXJuIHN1YmdyYXBoUHJvdmlkZXJcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgICBsb2cuZXJyb3IoeyBlcnIgfSwgJ0FXUyBTdWJncmFwaCBQcm92aWRlciB1bmF2YWlsYWJsZSwgZGVmYXVsdGluZyB0byBTdGF0aWMgU3ViZ3JhcGggUHJvdmlkZXInKVxuICAgICAgICAgICAgICByZXR1cm4gbmV3IFN0YXRpY1YzU3ViZ3JhcGhQcm92aWRlcihjaGFpbklkLCB2M1Bvb2xQcm92aWRlcilcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KSgpLFxuICAgICAgICAgIChhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICBjb25zdCBzdWJncmFwaFByb3ZpZGVyID0gYXdhaXQgVjJBV1NTdWJncmFwaFByb3ZpZGVyLkVhZ2VyQnVpbGQoXG4gICAgICAgICAgICAgICAgUE9PTF9DQUNIRV9CVUNLRVRfMiEsXG4gICAgICAgICAgICAgICAgUE9PTF9DQUNIRV9LRVkhLFxuICAgICAgICAgICAgICAgIGNoYWluSWRcbiAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICByZXR1cm4gc3ViZ3JhcGhQcm92aWRlclxuICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICAgIHJldHVybiBuZXcgU3RhdGljVjJTdWJncmFwaFByb3ZpZGVyKGNoYWluSWQpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSkoKSxcbiAgICAgICAgXSlcblxuICAgICAgICBsZXQgcm91dGVDYWNoaW5nUHJvdmlkZXI6IElSb3V0ZUNhY2hpbmdQcm92aWRlciB8IHVuZGVmaW5lZCA9IHVuZGVmaW5lZFxuICAgICAgICBpZiAoQ0FDSEVEX1JPVVRFU19UQUJMRV9OQU1FICYmIENBQ0hFRF9ST1VURVNfVEFCTEVfTkFNRSAhPT0gJycpIHtcbiAgICAgICAgICByb3V0ZUNhY2hpbmdQcm92aWRlciA9IG5ldyBEeW5hbW9Sb3V0ZUNhY2hpbmdQcm92aWRlcih7IGNhY2hlZFJvdXRlc1RhYmxlTmFtZTogQ0FDSEVEX1JPVVRFU19UQUJMRV9OQU1FIH0pXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGNoYWluSWQsXG4gICAgICAgICAgZGVwZW5kZW5jaWVzOiB7XG4gICAgICAgICAgICBwcm92aWRlcixcbiAgICAgICAgICAgIHRva2VuTGlzdFByb3ZpZGVyOiBhd2FpdCBBV1NUb2tlbkxpc3RQcm92aWRlci5mcm9tVG9rZW5MaXN0UzNCdWNrZXQoXG4gICAgICAgICAgICAgIGNoYWluSWQsXG4gICAgICAgICAgICAgIFRPS0VOX0xJU1RfQ0FDSEVfQlVDS0VUISxcbiAgICAgICAgICAgICAgREVGQVVMVF9UT0tFTl9MSVNUXG4gICAgICAgICAgICApLFxuICAgICAgICAgICAgYmxvY2tlZFRva2VuTGlzdFByb3ZpZGVyOiBhd2FpdCBDYWNoaW5nVG9rZW5MaXN0UHJvdmlkZXIuZnJvbVRva2VuTGlzdChcbiAgICAgICAgICAgICAgY2hhaW5JZCxcbiAgICAgICAgICAgICAgVU5TVVBQT1JURURfVE9LRU5fTElTVCBhcyBUb2tlbkxpc3QsXG4gICAgICAgICAgICAgIGJsb2NrZWRUb2tlbkNhY2hlXG4gICAgICAgICAgICApLFxuICAgICAgICAgICAgbXVsdGljYWxsUHJvdmlkZXI6IG11bHRpY2FsbDJQcm92aWRlcixcbiAgICAgICAgICAgIHRva2VuUHJvdmlkZXIsXG4gICAgICAgICAgICB0b2tlblByb3ZpZGVyRnJvbVRva2VuTGlzdDogdG9rZW5MaXN0UHJvdmlkZXIsXG4gICAgICAgICAgICBnYXNQcmljZVByb3ZpZGVyOiBuZXcgQ2FjaGluZ0dhc1N0YXRpb25Qcm92aWRlcihcbiAgICAgICAgICAgICAgY2hhaW5JZCxcbiAgICAgICAgICAgICAgbmV3IE9uQ2hhaW5HYXNQcmljZVByb3ZpZGVyKFxuICAgICAgICAgICAgICAgIGNoYWluSWQsXG4gICAgICAgICAgICAgICAgbmV3IEVJUDE1NTlHYXNQcmljZVByb3ZpZGVyKHByb3ZpZGVyKSxcbiAgICAgICAgICAgICAgICBuZXcgTGVnYWN5R2FzUHJpY2VQcm92aWRlcihwcm92aWRlcilcbiAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgbmV3IE5vZGVKU0NhY2hlKG5ldyBOb2RlQ2FjaGUoeyBzdGRUVEw6IDE1LCB1c2VDbG9uZXM6IGZhbHNlIH0pKVxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIHYzU3ViZ3JhcGhQcm92aWRlcixcbiAgICAgICAgICAgIG9uQ2hhaW5RdW90ZVByb3ZpZGVyOiBxdW90ZVByb3ZpZGVyLFxuICAgICAgICAgICAgdjNQb29sUHJvdmlkZXIsXG4gICAgICAgICAgICB2MlBvb2xQcm92aWRlcixcbiAgICAgICAgICAgIHYyUXVvdGVQcm92aWRlcjogbmV3IFYyUXVvdGVQcm92aWRlcigpLFxuICAgICAgICAgICAgdjJTdWJncmFwaFByb3ZpZGVyLFxuICAgICAgICAgICAgc2ltdWxhdG9yLFxuICAgICAgICAgICAgcm91dGVDYWNoaW5nUHJvdmlkZXIsXG4gICAgICAgICAgfSxcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICApXG5cbiAgICBmb3IgKGNvbnN0IHsgY2hhaW5JZCwgZGVwZW5kZW5jaWVzIH0gb2YgZGVwZW5kZW5jaWVzQnlDaGFpbkFycmF5KSB7XG4gICAgICBkZXBlbmRlbmNpZXNCeUNoYWluW2NoYWluSWRdID0gZGVwZW5kZW5jaWVzXG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIGRlcGVuZGVuY2llczogZGVwZW5kZW5jaWVzQnlDaGFpbixcbiAgICB9XG4gIH1cbn1cbiJdfQ==